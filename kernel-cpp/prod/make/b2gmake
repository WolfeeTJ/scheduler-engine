#!/bin/bash

if [ "$1" != "" ]; then $0 <$1 >$1.gnumake; 
else

#if [ -e $1~gnumake ]; then rm $1~gnumake; fi


cat >/tmp/$$.b2gmake.awk << \\EOF
BEGIN {
    print "# Dieses Makefile ist mit b2gmake aus einem Borland-Makefile generiert worden."
    print "# DO NOT EDIT THIS FILE!"
    print " "
    print "GNUMAKE=1"
    print " "
}
 
{
    if( $0 ~ /^!/ )                                 # !direktive --> direktive
    {
         print substr( $0, 2 ); 
    }
    else
    if( $0 ~ /^[a-zA-Z_]* *=/ )                     # name = value  -->  name := value
    {
        x = $0; 
        sub( "=", ":=", x ); 
        print x;  
    } 
    else
    if( $0 ~ /^\.PATH./ )                           # .PATH.ext = path  --> vpath %.ext path
    {
        x = substr( $0, 7 )
        gsub( "=", " ", x )
        print "vpath %." x
    }
    else
    if( $0 ~ /^\.[a-z]*\.[a-z]*:/ )                 # .dep.tar:  -->  %.tar: %.dep
    {
        m = match( substr( $0, 2 ), "\\." )
        depend = substr( $0, 2, m - 1 )
        target = substr( $0, m + 2 )
        gsub( "[ :]", "", target )
        print( "%." target ": %." depend )
    }
    else
    if( $0 ~ /^ *rem/ )                             # rem --> # rem 
    {
        print "# " $0
    }
    else
    if( $0 ~ /^ / )
    {
        print "\t" substr( $0, 2 )
    }
    else
    {
        print;
    }
}    
\EOF
if [ -f /etc/dfs/dfstab ] 
then

    # Wir sind auf Solaris 2.3
    # Perl-Skript wird benutzt (kann auch mit a2p aus dem awk-Teil erzeugt werden)

    /usr/local/bin/a2p < /tmp/$$.b2gmake.awk > /tmp/$$.b2gmake.perl &&
    chmod +x /tmp/$$.b2gmake.perl &&
    /tmp/$$.b2gmake.perl &&
    rm -f /tmp/$$.b2gmake.perl 
    #/usr/local/bin/perl /usr/sos/e/b2g.pl

else

    # !Solaris 2.3 (Linux etc.)
    awk -f /tmp/$$.b2gmake.awk 
fi

#test rm -f /tmp/$$.b2gmake.awk

fi
