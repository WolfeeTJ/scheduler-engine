<?xml version="1.0" encoding="iso-8859-1"?>
<!--
\brief Prepare the necessary resources from JS kernel for setup 

\details
This buildfile provides the necessary resources of the scheduler kernel to build a setup. It based on the result of running dependency:copy and
dependency:copy-dependencies.

The main target of this build (setup.platform) is called by maven via the pom.xml in this directory. The build is not able
to run without maven integration.

\version 1.0
\date 2011-06-21
-->
<project name="SOSJobSchedulerModel" basedir=".">

	<taskdef resource="net/sf/antcontrib/antcontrib.properties" classpath="${settings.localRepository}/ant-contrib/ant-contrib/1.0b3/ant-contrib-1.0b3.jar"/>
	

	<property name="setup.platform" value="linux-i386" />
	<property name="package.name" value="com.sos.scheduler" />
	<property name="source.dir" value="${basedir}/target/dependency" />
	<property name="target.dir" value="${basedir}/target/setup" />
	
	<target name="setup.platform" depends="-init, -copy, -copy.platform"	description="platform specific setup preparation">
    <echo message="DONE !!" />
  </target>

	<target name="-init" description="initialize the platform specific settings">

    <echo message="${settings.localRepository}" />

    <if>
     <equals arg1="${setup.platform}" arg2="windows-x86" />
     <then>
        <property name="folder.name" value="windows" />
      	<fileset dir="${source.dir}/${folder.name}" id="files.bin.platform">
      		<include name="scheduler.exe"/>
      		<include name="spidermonkey.dll"/>
      	</fileset>
      	<fileset dir="${source.dir}/${folder.name}" id="files.lib.platform">
      		<include name="scheduler.dll"/>
      	</fileset>
     </then>
    </if>

    <if>
     <equals arg1="${setup.platform}" arg2="linux-i386" />
     <then>
        <property name="folder.name" value="linux32" />
      	<fileset dir="${source.dir}/${folder.name}" id="files.bin.platform">
      		<include name="scheduler"/>
      	</fileset>
      	<fileset dir="${source.dir}/${folder.name}" id="files.lib.platform">
      		<include name="libspidermonkey.so"/>
      	</fileset>
     </then>
    </if>

    <if>
     <equals arg1="${setup.platform}" arg2="hpux-itanium" />
     <then>
    		<echo message="HP-UX" />
    		<!--
        <property name="folder.name" value="hpux-ia64-32" />
    		-->
     </then>
    </if>

    <if>
     <equals arg1="${setup.platform}" arg2="solaris-" />
     <then>
    		<echo message="SOLARIS" />
    		<!--
        <property name="folder.name" value="solarisx86" />
    		-->
     </then>
    </if>
    <echo message="the folder name is ${folder.name}" />
  	
  	<fileset dir="${source.dir}/${folder.name}" id="files.config">
  		<include name="scheduler.xsd"/>
  	</fileset>
  	
  	<fileset dir="${source.dir}" id="files.lib">
  		<include name="com.sos.scheduler.engine.jar*"/>
  	</fileset>
  	
  	<fileset dir="${source.dir}" id="files.jar">
  		<include name="guava*.jar"/>
  		<include name="log4j-*.jar"/>
  	</fileset>

  </target>
		
	<target name="-copy.platform" description="copy the platform specific files" if="folder.name">

    <echo message="the folder name is ${folder.name}" />
		<copy todir="${target.dir}/scheduler.${folder.name}/lib">
			<fileset refid="files.lib.platform" />
		</copy>

		<copy todir="${target.dir}/scheduler.${folder.name}/bin">
			<fileset refid="files.bin.platform" />
		</copy>

  </target>
	
	<target name="-copy" description="copy all setup files for the scheduler kernel into a directory">
	
		<!-- unzip the binary files into a working directory -->
 		<echo message="working for ${setup.platform}" />
		<unzip dest="${source.dir}/${folder.name}">
	    <patternset>
	        <exclude name="*.map"/>
	        <exclude name="*.pdb"/>
	    </patternset>
	    <fileset dir="${source.dir}">
	        <include name="*${setup.platform}.zip"/>
	    </fileset>
		</unzip>
		
		<!-- copy the sos specific jar files to the target directory and normalize theirs names -->
		<copy todir="${target.dir}/scheduler/config">
			<fileset refid="files.config" />
		</copy>
		<copy todir="${target.dir}/scheduler/lib">
			<fileset refid="files.lib" />
		  <mapper type="regexp" from="^com.sos.scheduler.engine.jar-(.*)\.jar$" to="com.sos.spooler.\1.jar"/>
		</copy>
		<copy todir="${target.dir}/scheduler/lib">
			<fileset refid="files.jar" />
		</copy>
		
		<touch file="${target.dir}/${setup.version}.txt" />
		
	</target>

</project>
