<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet href="scheduler.xsl" type="text/xsl"?>

<!--$Id$-->

<description 
    title       = "Verzeichnisüberwachung" 
    base_dir    = ""
    parent_page = "job.xml"
    author      = "$Author$"
    date        = "$Date$"
>

    <p>
        Ein Job, der in einem Verzeichnis eintreffende Dateien verarbeitet, 
        kann sich der Verzeichnisüberwachung bedienen.
        Mit dem Aufruf <scheduler_method class="Job" method="start_when_directory_changed" java_signature="java.lang.String"/>
        sorgt der Scheduler dafür, dass eine Task läuft, sobald sich das Verzeichnis ändert.
    </p>
    <p>
        Sie können den Aufruf für mehrere Verzeichnisse wiederholen.
    </p>
    <p>
        Der Aufruf kann im Scheduler-Skript (Element <code>&lt;script></code> in <scheduler_element name="config"/>)
        oder im Job selbst (in <scheduler_method class="Job_impl" method="spooler_init"/>) untergebracht sein.
        Im letzten Fall muss der Job einmal laufen, damit der Aufruf auch ausgeführt wird 
        (s. <scheduler_element name="run_time" attribute="once" value="yes"/>).
    </p>
    
    
    
    <h2>Was ist eine Änderung eines Verzeichnisses?</h2>
    
        <p>
            Wenn eine Datei oder ein Unterverzeichnis hinzugefügt, gelöscht oder umbenannt wird.
        </p>
    
    
    <h2>Mit Regulärem Ausdruck filtern</h2>
    
        <p>
            Der Methode <scheduler_method class="Job" method="start_when_directory_changed" java_signature="java.lang.String, java.lang.String"/>
            können Sie einen Regulären Ausdruck (nach POSIX 1003.2) übergeben.
            Der Scheduler betrachtet dann das Verzeichnis nur als geändert, 
            wenn es nach der Änderung eine Datei oder ein Verzeichnis enthält,
            dessen Name zum Regulären Ausdruck passt.
        </p>
        
        
    <h2>Welches Verzeichnis hat sich geändert?</h2>        
    
        <p>
            Wenn Sie mehrere Verzeichnisse überwachen, gibt der Aufruf
            <scheduler_method class="Task" method="changed_directories"/>
            die Namen der geänderten Verzeichnisse zurück, durch Semikolon getrennt.
        </p>
    
    
    <h2>Fehler bei der Verzeichnisüberwachung</h2>    
    
        <p>
            Wenn z.B. ein Verzeichnis nicht mehr zugreifbar ist (gelöscht oder nicht mehr erreichbar),
            gilt das als Änderung und der Scheduler startet eine Task.
        </p>
        <p>
            Ein wiederholter Aufruf von 
            <scheduler_method class="Job" method="start_when_directory_changed" java_signature="java.lang.String"/>
            führt dann zu einem Fehler.
        </p>


    <h2>Beispiel</h2>
        
        <p>
            Konfiguration für einen Job, der alle Dateien in einem Verzeichnis verarbeitet und dann löscht
            (Vorsicht beim Test! Der Job löscht wirklich!)
        </p>
    
        <pre>
        
&lt;?xml version="1.0" encoding="iso-8859-1"?>
&lt;spooler>
    &lt;config>
        &lt;process_classes/>

        &lt;jobs>
            &lt;job name="import">

                &lt;script java_class="spooler_job.Import">&lt;![CDATA[

                    package spooler_job;
                    import java.io.File;

                    public class Import  extends sos.spooler.Job_impl
                    {
                        File      directory = new File( "/tmp/test-import" );   // Vorsicht! Dateien werden gelöscht!
                        File[]    files;
                        int       index = 0;
                                  
                        public boolean spooler_init()
                        {
                            spooler_job.start_when_directory_changed( directory );
                            files = directory.listFiles();
                            return files.length > 0;
                        }
                            
                        public boolean spooler_process()
                        {     
                            File file = files[ index++ ];
                            spooler_log.info( "Verarbeite Datei " + file );
                            file.delete();
                            return index &lt; files.length;
                        }
                    }

                ]]&gt;&lt;/script>

                &lt;run_time once="yes"/>
            &lt;/job>
        &lt;/jobs>
    &lt;/config>
&lt;/spooler>
        </pre>
        
                
</description>
