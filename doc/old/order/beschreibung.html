<html>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<meta name="ProgId" content="FrontPage.Editor.Document">
<style type="text/css">
h1           { font-size: 24pt; font-weight: bold; margin-bottom: 4ex;  }
h2           { font-size: 12pt; font-weight: bold; margin-top: 10ex; }
h3           { font-size: 10pt; font-weight: bold; margin-top: 6ex }
.zwischentitel { font-weight: bold; margin-top: 6ex }
td           { font-size: 10pt; margin-top: 2ex; margin-bottom: 0  }
p            { font-size: 10pt; margin-top: 2ex; margin-bottom: 0  }
li           { font-size: 10pt }
pre          { font-family: Lucida Console, monospace; font-size: 9pt; margin-left: 5mm; line-height: 1.2em; }
hr           { size: 1 }
.indent      { margin-left: 5mm; }
.mono        { font-family: Lucida Console, monospace; font-size: 9pt }
</style>

<title>Aufträge im Spooler</title>
</head>
<body>



<h1>Aufträge im Spooler
</h1>

<p align="right">4. Oktober 2002
</p>

<h2>Inhalt
</h2>
<p><a href="#jobkette">Jobkette</a>
</p>
<p><a href="#job">Auftragsgesteuerter Job</a>
</p>
<p><a href="#priorisierung">Priorisierung der Jobs - Beschleunigung des
Auftragsdurchlaufs</a>
</p>
<p><a href="#auftrag">Auftrag</a>
</p>
<p><a href="#auftragsliste">Auftragsliste</a>
</p>
<p><a href="#auftrag_tcp">Auftrag per TCP und XML erteilen</a>
</p>

<p class="indent">&nbsp;</p>
<hr size="1">

<h2><a name="jobkette"></a>Jobkette
</h2>
<p>Eine Jobkette wird mit <font class="mono"><a href="classes/spooler.html#create_job_chain">spooler.create_job_chain()</a></font>
erzeugt, mit<a href="classes/job_chain.html#add_job"> <font class="mono">job_chain.add_job()</font> </a> aufgebaut und mit <font class="mono"><a href="classes/spooler.html#add_job_chain">spooler.add_job_chain()</a></font>
dem Spooler übergeben (und dabei geprüft).
</p>
<pre>&lt;spooler&gt;
    &lt;script&gt;
<font color="#0000FF">        set job_chain = spooler.create_job_chain()

        job_chain.name = </font><font color="#0000FF">&quot;dokument_drucken&quot;</font>
<font color="#0000FF">
        job_chain.add_job &quot;aufbereiten&quot;, 100,  400, 8888
        job_chain.add_job &quot;drucken&quot;    , 400, 1000, 8888
        job_chain.add_end_state 1000
</font>
        on error goto 0
<font color="#0000FF">          spooler.add_job_chain job_chain</font><span style="background-color: #FFFF00">
</span>          if err then spooler_log.warn &quot;Fehler in der Jobkette wird ignoriert: &quot; &amp; err.description
        on error resume next
    &lt;/script&gt;
&lt;/job&gt;</pre>
<p>oder</p>
<pre>&lt;spooler&gt;
    &lt;script&gt;
<font color="#0000FF">        set job_chain = spooler.create_job_chain()
</font>
<font color="#0000FF">        job_chain.name = &quot;dokument_drucken&quot;</font>
<font color="#0000FF">
        job_chain.add_job &quot;aufbereiten&quot;
        job_chain.add_job &quot;drucken&quot;

        spooler.add_job_chain job_chain</font><span style="background-color: #FFFF00">
</span>    &lt;/script&gt;
&lt;/job&gt;</pre>
<hr size="1">
<h2><a name="job"></a>Auftragsgesteuerter Job
</h2>
<p>Das Attribut <font class="mono">order=&quot;yes&quot;</font> im Element <font class="mono">&lt;job&gt;</font>
kennzeichnet den Job als auftragsgesteuert. Der Spooler stellt beim Aufruf von <font class="mono">spooler_process()</font>
den Auftrag in <font class="mono">spooler_task.order</font> bereit.&nbsp;</p>
<pre>&lt;job name=&quot;aufbereiten&quot; <font color="#0000FF">order=&quot;yes&quot;</font>&gt;
    &lt;script&gt;
        function spooler_process
            ok = verarbeite( spooler_task.order.payload )
            spooler_process = ok
        end function
    &lt;/script&gt;
&lt;/job&gt;</pre>
<p class="zwischentitel">Rückgabewert von spooler_process()</p>
<p>Ein Fehler in <font class="mono">spooler_process()</font>  führt wie gewohnt
zum Stopp des Jobs.</p>
<p>Wenn nur der Auftrag fehlerhaft ist, der Job aber weiterlaufen soll, gibt <font class="mono">spooler_process()</font>
false zurück. True heißt, dass der Jobschritt ordentlich ausgeführt worden
ist.</p>
<p class="zwischentitel">Zustand des Auftrags</p>
<p>Der Job kann selbst die Position des Auftrags in der Jobkette bestimmen. Direkt durch Angabe
des Jobs</p>
<pre><a href="classes/order.html#job">order.job</a> = &quot;drucken&quot;</pre>
<p>oder über den Zustand</p>
<pre><a href="classes/order.html#state">order.state</a> = 400</pre>
<p>Der Spooler fügt dann den Auftrag sofort die andere Auftragsliste ein. Die Operation sollte also
zum Schluss ausgeführt werden, weil der andere Job, wenn er in einem anderen
Thread liegt, sofort starten kann.</p>
<p>Wenn der Job nicht den Zustand geändert hat und der Auftrag sich in einer
Jobkette befindet, ändert der Spooler den Zustand, wie es in der Jobkette
festgelegt ist. Der Auftrag wird dadurch dem nächsten Job zugeführt oder
beendet.</p>
<p class="zwischentitel">Beenden der Task</p>
<p>Eine auftragsgesteuerte Task beendet sich nur in diesen Fällen:</p>
<ul>
<li>Die &lt;run_time&gt; läuft ab (es gilt <font class="mono"> let_run=&quot;no&quot;</font>).</li>
<li>Explizit durch Aufruf von <font class="mono"> spooler_task.end()</font></li>
</ul>
<hr size="1">
<h2><a name="priorisierung"></a>Priorisierung der Jobs - Beschleunigung des
Auftragsdurchlaufs</h2>
<p>Auftragsgesteuerte Jobs haben eine eigene Priorisierung. Das Attribut
priority= in &lt;job&gt; kann hier nicht verwendet werden, es wirkt nicht.</p>
<p>Für jeden Thread gilt:</p>
<ul>
<li>Auftragsgesteuerte Jobs werden zuerst ausgeführt, bis sie nichts mehr zu
tun haben.</li>
<li>Auftragsgesteuerte Jobs, die weiter hinten in einer Jobkette stehen, werden
zuerst ausgeführt, bis sie nichts mehr zu tun haben</li>
<li>Nur, wenn kein auftragsgesteuerter Job ausgeführt worden ist, sind die
anderen dran</li>
</ul>
<p>Zwei Jobs, die an gleicher Stelle in verschiedenen Jobketten stehen, werden
abwechselnd ausgeführt.</p>
<p>Die Priorisierung verdrängt bei kontinuierlichem Auftragseingang die
schlechter priorisierten Jobs. Sollen die Jobs dennoch zum Zuge kommen, können
sie in einen anderen Thread gelegt werden.</p>
<p>&nbsp;</p>
<hr size="1">
<h2><a name="auftrag"></a>Auftrag
</h2>
<p>Ein <a href="classes/order.html"> Auftrag</a> hat einige beschreibene
Eigenschaften (<font class="mono"><a href="classes/order.html#id">id</a></font>,
<font class="mono"><a href="classes/order.html#title">title</a></font>, <font class="mono"><a href="classes/order.html#state_text">state_text</a></font>),
einen Zustand (<font class="mono"><a href="classes/order.html#state">state</a></font>,
<font class="mono"><a href="classes/order.html#job">job</a></font>), eine
Priorität (<font class="mono"><a href="classes/order.html#priority">priority</a></font>),
kann einer Jobkette zugeordnet sein (<font class="mono"><a href="classes/order.html#job_chain">job_chain</a></font>)
und enthält vor allem die zu verarbeitenden Daten (<font class="mono"><a href="classes/order.html#payload">payload</a></font>).&nbsp;
</p>
<p><font class="mono"><b><br>
</b></font>
</p>
<hr size="1">
<h2><a name="auftragsliste"></a>Auftragsliste
</h2>
<p class="zwischentitel">Auftrag einem Job zuordnen</p>
<p>Jeder auftragsgesteuerte Job hat eine Auftragsliste, die vom Spooler im
Speicher gehalten wird. Der Job wird gestartet, sobald die Auftragsliste nicht
leer ist (und seine <font class="mono"> &lt;run_time&gt;</font> es erlaubt).</p>
<p>Die Auftragsliste eines Jobs kann mit diesem Aufruf gefüllt werden:</p>
<p class="indent"><font class="mono">spooler.job( &quot;</font><i>jobname</i><font class="mono">&quot;
).order_queue.add_order </font><i>payload</i><font class="mono"> </font><i>|</i><font class="mono">
</font><i>order</i></p>
<p><br>
Als Parameter kann direkt die Nutzlast übergeben werden.&nbsp;</p>
<pre>spooler.job(&quot;drucken&quot;).order_queue.add_order file.get()       'Einfacher Fall</pre>
<p>Der Spooler baut implizit einen Auftrag zusammen und setzt die <font class="mono">payload</font>
des Auftrags auf den Hostware-Datensatz.</p>
<p><br>
Wenn weitere Angaben zum Auftrag gemacht werden sollen, kann er auch selbst
zusammengebaut werden:</p>
<pre>set record = file.get()              'Inhalt des Auftrags

set order = spooler.create_order()

set order.payload  = record
    order.id       = record.id
    order.priority = 100
    order.title    = &quot;Dokument der Vorlage &quot; &amp; order.templatename

spooler.job(&quot;drucken&quot;).order_queue.add_order order</pre>
<p><font class="mono"><br>
add_order() </font>liefert eingefügten Auftrag als Funktionsergebnis.</p>
<p class="zwischentitel">Auftrag in eine Jobkette einfügen</p>
<p>Die Auftragsliste einer Jobkette ist eigentlich die Auftragslisten der Jobs
darin. Die Position des Auftrags bestimmt den Job.</p>
<p class="indent"><font class="mono">spooler.job_chain(&quot;</font><i>name</i><font class="mono">&quot;).add_order</font>
 <i>payload</i><font class="mono"> </font><i>|</i><font class="mono"> </font><i>order</i></p>
<p>z.B.</p>
<pre>set order = spooler.job_chain(&quot;dokument_drucken&quot;).add_order file.get()       'Einfacher Fall
spooler_log &quot;Vom Spooler vergebene Auftragskennung ist &quot; &amp; order.id</pre>
<p>oder</p>
<pre>set record = file.get()              'Inhalt des Auftrags

set order = <font color="#0000FF">spooler.create_order()</font>

set order<font color="#0000FF">.payload</font>  = record
    order<font color="#0000FF">.id</font>       = record.id
    order<font color="#0000FF">.priority</font> = 100
    order<font color="#0000FF">.title</font>    = &quot;Dokument der Vorlage &quot; &amp; order.templatename

<font color="#0000FF">spooler.job_chain(&quot;</font>dokumment_drucken<font color="#0000FF">&quot;).add_order order</font></pre>
<p><font class="mono"><br>
add_order() </font>liefert eingefügten Auftrag als Funktionsergebnis.</p>
<h3>Erkennung doppelter Aufträge</h3>
<p>Beide Methoden<font class="mono"> add_order()</font> (der Auftragsliste des
Jobs und der Jobkette) prüfen anhand der id, ob der Auftrag schon eingetragen
ist. Natürlich nur, wenn die <font class="mono">id</font> auch gesetzt ist. Hat
die Auftragsliste oder Jobkette bereits einen Auftrag mit derselben <font class="mono">id</font>,
wird er ersetzt. Wenn die Priorität nicht eingestellt (oder 0) ist, ändert der
Spooler die Stelle in der Liste nicht.&nbsp;</p>
<h3>Anzahl der Aufträge</h3>
<p><font class="mono">spooler.job(&quot;</font><i>job</i><font class="mono">&quot;).<a href="classes/job.html#order_queue">order_queue</a>.<a href="classes/order_queue.html#length">length</a></font>
liefert die Anzahl der Aufträge der Auftragsliste.</p>
<p><font class="mono">spooler.<a href="classes/spooler.html#job_chain">job_chain</a>(&quot;</font><i>jobkette</i><font class="mono">&quot;).length</font>
liefert die Anzahl der Aufträge in der Jobkette, also die Summe der Längen
aller Auftragslisten darin.</p>
<p>&nbsp;</p>
<hr size="1">
<h2><a name="auftrag_tcp"></a>Aufträge über die TCP-Schnittstelle übergeben
</h2>
<p>Über das XML-Element <font class="mono"><a href="xml/add_order.html">&lt;add_order&gt;</a></font> kann ein
Auftrag an eine Jobkette übergeben werden. Die Attribute <font class="mono">position</font>,
<font class="mono">priority</font>, <font class="mono">id</font> und <font class="mono">title</font>
sind optional. Die Parameter werden als <font class="mono">Variable_set</font>
übergeben.
</p>
<pre>&lt;add_order job_chain=&quot;<i>name</i>&quot; position=&quot;<i>position</i>&quot; priority=&quot;<i>priority</i>&quot; id=&quot;<i>id</i>&quot; title=&quot;<i>title</i>&quot;&gt;
    &lt;params&gt;
        &lt;param name=&quot;<i>param1</i>&quot; value=&quot;<i>wert1</i>&quot;/&gt;
        ...
    &lt;/params&gt;
&lt;/add_order&gt;</pre>
<p>Ein Auftrag kann auch direkt einem Job zugestellt werden. Die Attribute <font class="mono">job_chain</font>
und <font class="mono">position</font> werden dann durch <font class="mono">job</font>
ersetzt.
</p>
<pre>&lt;add_order job=&quot;<i>name</i>&quot; priority=&quot;<i>priority</i>&quot; id=&quot;<i>id</i>&quot; title=&quot;<i>title</i>&quot;&gt;
    &lt;params&gt;
        ....
    &lt;/params&gt;
&lt;/add_order&gt;</pre>
<p>&nbsp;
</p>

<p>&nbsp;
</p>

<p>&nbsp;
</p>

<HR SIZE=1>
<FONT face="Arial" size="2">Dipl.-Inform. Joacim Zschimmer&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
<A href="mailto:j@zsch.de">j@zsch.de</A>
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;(030) 3470 2520&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Zschimmer GmbH</FONT>

</body>

</html>
